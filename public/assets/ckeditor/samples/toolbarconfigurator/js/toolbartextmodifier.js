!function(){function e(e){t.call(this,e),this.hintContainer=this.codeContainer=null}var t=ToolbarConfigurator.AbstractToolbarModifier,a=ToolbarConfigurator.FullToolbarEditor;return ToolbarConfigurator.ToolbarTextModifier=e,e.prototype=Object.create(t.prototype),e.prototype._onInit=function(e,a){t.prototype._onInit.call(this,void 0,a),this._createModifier(a?this.actualConfig:void 0),"function"==typeof e&&e(this.mainContainer)},e.prototype._createModifier=function(e){function i(e){var t=l(e);if(null!==t.charsBetween){var a=r.getUnusedButtonsArray(r.actualConfig.toolbar,!0,t.charsBetween),i=e.getCursor(),t=CodeMirror.Pos(i.line,i.ch-t.charsBetween.length),o=e.getTokenAt(i);if("{"===e.getTokenAt({line:i.line,ch:o.start}).string&&(a=["name"]),0!==a.length)return new n(t,i,a)}}function n(e,t,a){this.from=e,this.to=t,this.list=a,this._handlers=[]}function l(e,t){var a={};a.cur=e.getCursor(),a.tok=e.getTokenAt(a.cur),a["char"]=t||a.tok.string.charAt(a.tok.string.length-1);var i=e.getRange(CodeMirror.Pos(a.cur.line,0),a.cur).split("").reverse().join(""),i=i.replace(/(['|"]\w*['|"])/g,"");return a.charsBetween=i.match(/(^\w*)(['|"])/),a.charsBetween&&(a.endChar=a.charsBetween[2],a.charsBetween=a.charsBetween[1].split("").reverse().join("")),a}function o(e){return setTimeout(function(){e.state.completionActive||CodeMirror.showHint(e,i,{hintsClass:"toolbar-modifier",completeSingle:!1})},100),CodeMirror.Pass}var r=this;this._createToolbar(),this.toolbarContainer&&this.mainContainer.append(this.toolbarContainer),t.prototype._createModifier.call(this),this._setupActualConfig(e),e=this.actualConfig.toolbar,e=CKEDITOR.tools.isArray(e)?"\tconfig.toolbar = "+("[\n\t\t"+a.map(e,function(e){return t.stringifyJSONintoOneLine(e,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0})}).join(",\n\t\t")+"\n\t]")+";":"config.toolbar = [];",e=["CKEDITOR.editorConfig = function( config ) {\n",e,"\n};"].join("");var s=new CKEDITOR.dom.element("div");s.addClass("codemirror-wrapper"),this.modifyContainer.append(s),this.codeContainer=CodeMirror(s.$,{mode:{name:"javascript",json:!0},lineNumbers:!1,lineWrapping:!0,viewportMargin:1/0,value:e,smartIndent:!1,indentWithTabs:!0,indentUnit:4,tabSize:4,theme:"neo",extraKeys:{Left:o,Right:o,"'''":o,"'\"'":o,Backspace:o,Delete:o,"Shift-Tab":"indentLess"}}),this.codeContainer.on("endCompletion",function(e,t){var a=l(e);void 0!==t&&e.replaceSelection(a.endChar)}),this.codeContainer.on("change",function(){var e=r.codeContainer.getValue(),e=r._evaluateValue(e);null!==e?(r.actualConfig.toolbar=e.toolbar?e.toolbar:r.actualConfig.toolbar,r._fillHintByUnusedElements(),r._refreshEditor(),r.mainContainer.removeClass("invalid")):r.mainContainer.addClass("invalid")}),this.hintContainer=new CKEDITOR.dom.element("div"),this.hintContainer.addClass("toolbarModifier-hints"),this._fillHintByUnusedElements(),this.hintContainer.insertBefore(s)},e.prototype._fillHintByUnusedElements=function(){var e=this.getUnusedButtonsArray(this.actualConfig.toolbar,!0),e=this.groupButtonNamesByGroup(e),t=a.map(e,function(e){var t=a.map(e.buttons,function(e){return"<code>"+e+"</code> "}).join("");return["<dt><code>",e.name,"</code></dt><dd>",t,"</dd>"].join("")}).join(" "),i='<dt class="list-header">Toolbar group</dt><dd class="list-header">Unused items</dd>';e.length||(i="<p>All items are in use.</p>"),this.codeContainer.refresh(),this.hintContainer.setHtml("<h3>Unused toolbar items</h3><dl>"+i+t+"</dl>")},e.prototype.getToolbarGroupByButtonName=function(e){var t,a=this.fullToolbarEditor.buttonNamesByGroup;for(t in a)for(var i=a[t],n=i.length;n--;)if(e===i[n])return t;return null},e.prototype.getUnusedButtonsArray=function(t,i,n){i=!0===i;var l=e.mapToolbarCfgToElementsList(t);return t=Object.keys(this.fullToolbarEditor.editorInstance.ui.items),t=a.filter(t,function(e){var t="-"===e;return e=void 0===n||0===e.toLowerCase().indexOf(n.toLowerCase()),!t&&e}),t=a.filter(t,function(e){return-1==CKEDITOR.tools.indexOf(l,e)}),i&&t.sort(),t},e.prototype.groupButtonNamesByGroup=function(e){var t,i=[],n=JSON.parse(JSON.stringify(this.fullToolbarEditor.buttonNamesByGroup));for(t in n){var l=n[t],l=a.filter(l,function(t){return-1!==CKEDITOR.tools.indexOf(e,t)});l.length&&i.push({name:t,buttons:l})}return i},e.mapToolbarCfgToElementsList=function(e){function t(e){return"-"!==e}for(var i=[],n=e.length,l=0;l<n;l+=1)e[l]&&"string"!=typeof e[l]&&(i=i.concat(a.filter(e[l].items,t)));return i},e.prototype._setupActualConfig=function(e){e=e||this.editorInstance.config,CKEDITOR.tools.isArray(e.toolbar)||(e.toolbarGroups||(e.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig(!0)),this._fixGroups(e),e.toolbar=this._mapToolbarGroupsToToolbar(e.toolbarGroups,this.actualConfig.removeButtons),this.actualConfig.toolbar=e.toolbar,this.actualConfig.removeButtons="")},e.prototype._mapToolbarGroupsToToolbar=function(e,t){t=t||this.editorInstance.config.removedBtns,t="string"==typeof t?t.split(","):[];for(var a=e.length;a--;){var i=this._mapToolbarSubgroup(e[a],t);"separator"===e[a].type?e[a]="/":CKEDITOR.tools.isArray(i)&&0===i.length?e.splice(a,1):e[a]="string"==typeof i?i:{name:e[a].name,items:i}}return e},e.prototype._mapToolbarSubgroup=function(e,t){if("string"==typeof e)return e;for(var a=e.groups?e.groups.length:0,i=[],n=0;n<a;n+=1){var l=e.groups[n],l=this.fullToolbarEditor.buttonsByGroup["string"==typeof l?l:l.name]||[],l=this._mapButtonsToButtonsNames(l,t),o=l.length,i=i.concat(l);o&&i.push("-")}return"-"==i[i.length-1]&&i.pop(),i},e.prototype._mapButtonsToButtonsNames=function(e,t){for(var a=e.length;a--;){var i=e[a],i="string"==typeof i?i:this.fullToolbarEditor.getCamelCasedButtonName(i.name);-1!==CKEDITOR.tools.indexOf(t,i)?e.splice(a,1):e[a]=i}return e},e.prototype._evaluateValue=function(e){var t;try{var a={};Function("var CKEDITOR = {}; "+e+"; return CKEDITOR;")().editorConfig(a),t=a;for(var i=t.toolbar.length;i--;)t.toolbar[i]||t.toolbar.splice(i,1)}catch(e){t=null}return t},e.prototype.mapToolbarToToolbarGroups=function(e){function t(e,t){e=e.slice();for(var a=t.length;a--;){var i=e.indexOf(t[a]);-1!==i&&e.splice(i,1)}return e}for(var a={},i=[],n=[],i=e.length,l=0;l<i;l++)if("/"===e[l])n.push("/");else{var o=e[l].items,r={};r.name=e[l].name,r.groups=[];for(var s=o.length,d=0;d<s;d++){var c=o[d];if("-"!==c){var u=this.getToolbarGroupByButtonName(c);-1===r.groups.indexOf(u)&&r.groups.push(u),a[u]=a[u]||{},u=a[u].buttons=a[u].buttons||{},u[c]=u[c]||{used:0,origin:r.name},u[c].used++}}n.push(r)}return i=function(e,a){var i,n=[];for(i in e)var l=e[i],o=a[i].slice(),n=n.concat(t(o,Object.keys(l.buttons)));return n}(a,this.fullToolbarEditor.buttonNamesByGroup),{toolbarGroups:n,removeButtons:i.join(",")}},e}();