CKEDITOR.dialog.add("colordialog",function(e){function a(){b.getById(f).removeStyle("background-color"),d.getContentElement("picker","selectedColor").setValue(""),i()}function t(e){e=e.data.getTarget();var a;"td"==e.getName()&&(a=e.getChild(0).getHtml())&&(i(),u=e,u.setAttribute("aria-selected",!0),u.addClass("cke_colordialog_selected"),d.getContentElement("picker","selectedColor").setValue(a))}function i(){u&&(u.removeClass("cke_colordialog_selected"),u.removeAttribute("aria-selected"),u=null)}function o(e){e=e.replace(/^#/,"");for(var a=0,t=[];2>=a;a++)t[a]=parseInt(e.substr(2*a,2),16);return 165<=.2126*t[0]+.7152*t[1]+.0722*t[2]}function n(e){!e.name&&(e=new CKEDITOR.event(e));var a,t=!/mouse/.test(e.name),i=e.data.getTarget();"td"==i.getName()&&(a=i.getChild(0).getHtml())&&(l(e),t?p=i:c=i,t&&i.addClass(o(a)?"cke_colordialog_focused_light":"cke_colordialog_focused_dark"),r(a))}function l(e){(e=!/mouse/.test(e.name)&&p)&&(e.removeClass("cke_colordialog_focused_light"),e.removeClass("cke_colordialog_focused_dark")),p||c||r(!1)}function r(e){e?(b.getById(y).setStyle("background-color",e),b.getById(S).setHtml(e)):(b.getById(y).removeStyle("background-color"),b.getById(S).setHtml("&nbsp;"))}function s(a){var i=a.data,o=i.getTarget(),n=i.getKeystroke(),l="rtl"==e.lang.dir;switch(n){case 38:(a=o.getParent().getPrevious())&&(a=a.getChild([o.getIndex()]),a.focus()),i.preventDefault();break;case 40:(a=o.getParent().getNext())&&(a=a.getChild([o.getIndex()]))&&1==a.type&&a.focus(),i.preventDefault();break;case 32:case 13:t(a),i.preventDefault();break;case l?37:39:(a=o.getNext())?1==a.type&&(a.focus(),i.preventDefault(!0)):(a=o.getParent().getNext())&&(a=a.getChild([0]))&&1==a.type&&(a.focus(),i.preventDefault(!0));break;case l?39:37:(a=o.getPrevious())?(a.focus(),i.preventDefault(!0)):(a=o.getParent().getPrevious())&&(a=a.getLast(),a.focus(),i.preventDefault(!0))}}var d,u,p,c,m,g=CKEDITOR.dom.element,b=CKEDITOR.document,h=e.lang.colordialog,k={type:"html",html:"&nbsp;"},v=function(e){return CKEDITOR.tools.getNextId()+"_"+e},y=v("hicolor"),S=v("hicolortext"),f=v("selhicolor");return function(){function e(e,t){for(var o=e;o<e+3;o++){var n=new g(m.$.insertRow(-1));n.setAttribute("role","row");for(var l=t;l<t+3;l++)for(var r=0;6>r;r++)a(n.$,"#"+i[l]+i[r]+i[o])}}function a(e,a){var i=new g(e.insertCell(-1));i.setAttribute("class","ColorCell cke_colordialog_colorcell"),i.setAttribute("tabIndex",-1),i.setAttribute("role","gridcell"),i.on("keydown",s),i.on("click",t),i.on("focus",n),i.on("blur",l),i.setStyle("background-color",a);var o=v("color_table_cell");i.setAttribute("aria-labelledby",o),i.append(CKEDITOR.dom.element.createFromHtml('<span id="'+o+'" class="cke_voice_label">'+a+"</span>",CKEDITOR.document))}m=CKEDITOR.dom.element.createFromHtml('<table tabIndex="-1" class="cke_colordialog_table" aria-label="'+h.options+'" role="grid" style="border-collapse:separate;" cellspacing="0"><caption class="cke_voice_label">'+h.options+'</caption><tbody role="presentation"></tbody></table>'),m.on("mouseover",n),m.on("mouseout",l);var i="00 33 66 99 cc ff".split(" ");e(0,0),e(3,0),e(0,3),e(3,3);var o=new g(m.$.insertRow(-1));o.setAttribute("role","row"),a(o.$,"#000000");for(var r=0;16>r;r++){var d=r.toString(16);a(o.$,"#"+d+d+d+d+d+d)}a(o.$,"#ffffff")}(),CKEDITOR.document.appendStyleSheet(CKEDITOR.getUrl(CKEDITOR.plugins.get("colordialog").path+"dialogs/colordialog.css")),{title:h.title,minWidth:360,minHeight:220,onLoad:function(){d=this},onHide:function(){a(),p.removeClass("cke_colordialog_focused_light"),p.removeClass("cke_colordialog_focused_dark"),r(!1),p=null},contents:[{id:"picker",label:h.title,accessKey:"I",elements:[{type:"hbox",padding:0,widths:["70%","10%","30%"],children:[{type:"html",html:"<div></div>",onLoad:function(){CKEDITOR.document.getById(this.domId).append(m)},focus:function(){(p||this.getElement().getElementsByTag("td").getItem(0)).focus()}},k,{type:"vbox",padding:0,widths:["70%","5%","25%"],children:[{type:"html",html:"<span>"+h.highlight+'</span><div id="'+y+'" style="border: 1px solid; height: 74px; width: 74px;"></div><div id="'+S+'">&nbsp;</div><span>'+h.selected+'</span><div id="'+f+'" style="border: 1px solid; height: 20px; width: 74px;"></div>'},{type:"text",label:h.selected,labelStyle:"display:none",id:"selectedColor",style:"width: 76px;margin-top:4px",onChange:function(){try{b.getById(f).setStyle("background-color",this.getValue())}catch(e){a()}}},k,{type:"button",id:"clear",label:h.clear,onClick:a}]}]}]}]}});