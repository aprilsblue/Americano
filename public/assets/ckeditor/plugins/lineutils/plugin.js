"use strict";!function(){function e(e,a){CKEDITOR.tools.extend(this,{editor:e,editable:e.editable(),doc:e.document,win:e.window},a,!0),this.inline=this.editable.isInline(),this.inline||(this.frame=this.win.getFrame()),this.target=this[this.inline?"editable":"doc"]}function a(e,a){CKEDITOR.tools.extend(this,a,{editor:e},!0)}function t(e,a){var t=e.editable();CKEDITOR.tools.extend(this,{editor:e,editable:t,inline:t.isInline(),doc:e.document,win:e.window,container:CKEDITOR.document.getBody(),winTop:CKEDITOR.document.getWindow()},a,!0),this.hidden={},this.visible={},this.inline||(this.frame=this.win.getFrame()),this.queryViewport();var i=CKEDITOR.tools.bind(this.queryViewport,this),o=CKEDITOR.tools.bind(this.hideVisible,this),n=CKEDITOR.tools.bind(this.removeAll,this);t.attachListener(this.winTop,"resize",i),t.attachListener(this.winTop,"scroll",i),t.attachListener(this.winTop,"resize",o),t.attachListener(this.win,"scroll",o),t.attachListener(this.inline?t:this.frame,"mouseout",function(e){var a=e.data.$.clientX,t=e.data.$.clientY;this.queryViewport(),(a<=this.rect.left||a>=this.rect.right||t<=this.rect.top||t>=this.rect.bottom)&&this.hideVisible(),(a<=0||a>=this.winTopPane.width||t<=0||t>=this.winTopPane.height)&&this.hideVisible()},this),t.attachListener(e,"resize",i),t.attachListener(e,"mode",n),e.on("destroy",n),this.lineTpl=new CKEDITOR.template(c).output({lineStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},u,this.lineStyle,!0)),tipLeftStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},d,{left:"0px","border-left-color":"red","border-width":"6px 0 6px 6px"},this.tipCss,this.tipLeftStyle,!0)),tipRightStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},d,{right:"0px","border-right-color":"red","border-width":"6px 6px 6px 0"},this.tipCss,this.tipRightStyle,!0))})}function i(e,a){return e&a}function o(e){return e&&e.type==CKEDITOR.NODE_ELEMENT}function n(e){return!(!p[e.getComputedStyle("float")]&&!p[e.getAttribute("align")])}function l(e){return!!m[e.getComputedStyle("position")]}function r(e){return o(e)&&"true"==e.getAttribute("contenteditable")}function s(e){return o(e)&&!n(e)&&!l(e)}CKEDITOR.plugins.add("lineutils"),CKEDITOR.LINEUTILS_BEFORE=1,CKEDITOR.LINEUTILS_AFTER=2,CKEDITOR.LINEUTILS_INSIDE=4,e.prototype={start:function(e){var a,t,i,o,n=this,l=this.editor,r=this.doc,s=CKEDITOR.tools.eventsBuffer(50,function(){l.readOnly||"wysiwyg"!=l.mode||(n.relations={},(t=r.$.elementFromPoint(i,o))&&t.nodeType&&(a=new CKEDITOR.dom.element(t),n.traverseSearch(a),isNaN(i+o)||n.pixelSearch(a,i,o),e&&e(n.relations,i,o)))});this.listener=this.editable.attachListener(this.target,"mousemove",function(e){i=e.data.$.clientX,o=e.data.$.clientY,s.input()}),this.editable.attachListener(this.inline?this.editable:this.frame,"mouseout",function(){s.reset()})},stop:function(){this.listener&&this.listener.removeListener()},getRange:function(){var e={};return e[CKEDITOR.LINEUTILS_BEFORE]=CKEDITOR.POSITION_BEFORE_START,e[CKEDITOR.LINEUTILS_AFTER]=CKEDITOR.POSITION_AFTER_END,e[CKEDITOR.LINEUTILS_INSIDE]=CKEDITOR.POSITION_AFTER_START,function(a){var t=this.editor.createRange();return t.moveToPosition(this.relations[a.uid].element,e[a.type]),t}}(),store:function(){function e(e,a,t){var i=e.getUniqueId();i in t?t[i].type|=a:t[i]={element:e,type:a}}return function(a,t){var o;i(t,CKEDITOR.LINEUTILS_AFTER)&&s(o=a.getNext())&&o.isVisible()&&(e(o,CKEDITOR.LINEUTILS_BEFORE,this.relations),t^=CKEDITOR.LINEUTILS_AFTER),i(t,CKEDITOR.LINEUTILS_INSIDE)&&s(o=a.getFirst())&&o.isVisible()&&(e(o,CKEDITOR.LINEUTILS_BEFORE,this.relations),t^=CKEDITOR.LINEUTILS_INSIDE),e(a,t,this.relations)}}(),traverseSearch:function(e){var a,t,i;do if(i=e.$["data-cke-expando"],!(i&&i in this.relations)){if(e.equals(this.editable))return;if(s(e))for(a in this.lookups)(t=this.lookups[a](e))&&this.store(e,t)}while(!r(e)&&(e=e.getParent()))},pixelSearch:function(){function e(e,t,i,o,n){for(var l,r=i,d=0;n(r);){if(r+=o,25==++d)return;if(l=this.doc.$.elementFromPoint(t,r))if(l!=e){if(a(e,l)&&(d=0,s(l=new CKEDITOR.dom.element(l))))return l}else d=0}}var a=CKEDITOR.env.ie||CKEDITOR.env.webkit?function(e,a){return e.contains(a)}:function(e,a){return!!(16&e.compareDocumentPosition(a))};return function(a,t,i){var o=this.win.getViewPaneSize().height,n=e.call(this,a.$,t,i,-1,function(e){return e>0}),l=e.call(this,a.$,t,i,1,function(e){return e<o});if(n)for(this.traverseSearch(n);!n.getParent().equals(a);)n=n.getParent();if(l)for(this.traverseSearch(l);!l.getParent().equals(a);)l=l.getParent();for(;(n||l)&&(n&&(n=n.getNext(s)),n&&!n.equals(l))&&(this.traverseSearch(n),l&&(l=l.getPrevious(s)),l&&!l.equals(n));)this.traverseSearch(l)}}(),greedySearch:function(){this.relations={};for(var e,a,t,i=this.editable.getElementsByTag("*"),o=0;e=i.getItem(o++);)if(!e.equals(this.editable)&&e.type==CKEDITOR.NODE_ELEMENT&&(e.hasAttribute("contenteditable")||!e.isReadOnly())&&s(e)&&e.isVisible())for(t in this.lookups)(a=this.lookups[t](e))&&this.store(e,a);return this.relations}},a.prototype={locate:function(){function e(e,a){var t=e.element[a===CKEDITOR.LINEUTILS_BEFORE?"getPrevious":"getNext"]();return t&&s(t)?(e.siblingRect=t.getClientRect(),a==CKEDITOR.LINEUTILS_BEFORE?(e.siblingRect.bottom+e.elementRect.top)/2:(e.elementRect.bottom+e.siblingRect.top)/2):a==CKEDITOR.LINEUTILS_BEFORE?e.elementRect.top:e.elementRect.bottom}return function(a){var t;this.locations={};for(var o in a)t=a[o],t.elementRect=t.element.getClientRect(),i(t.type,CKEDITOR.LINEUTILS_BEFORE)&&this.store(o,CKEDITOR.LINEUTILS_BEFORE,e(t,CKEDITOR.LINEUTILS_BEFORE)),i(t.type,CKEDITOR.LINEUTILS_AFTER)&&this.store(o,CKEDITOR.LINEUTILS_AFTER,e(t,CKEDITOR.LINEUTILS_AFTER)),i(t.type,CKEDITOR.LINEUTILS_INSIDE)&&this.store(o,CKEDITOR.LINEUTILS_INSIDE,(t.elementRect.top+t.elementRect.bottom)/2);return this.locations}}(),sort:function(){function e(e,t,i){return Math.abs(e-a[t][i])}var a,t,i,o;return function(n,l){a=this.locations,t=[];for(var r in a)for(var s in a[r])if(i=e(n,r,s),t.length){for(o=0;o<t.length;o++)if(i<t[o].dist){t.splice(o,0,{uid:+r,type:s,dist:i});break}o==t.length&&t.push({uid:+r,type:s,dist:i})}else t.push({uid:+r,type:s,dist:i});return"undefined"!=typeof l?t.slice(0,l):t}}(),store:function(e,a,t){this.locations[e]||(this.locations[e]={}),this.locations[e][a]=t}};var d={display:"block",width:"0px",height:"0px","border-color":"transparent","border-style":"solid",position:"absolute",top:"-6px"},u={height:"0px","border-top":"1px dashed red",position:"absolute","z-index":9999},c='<div data-cke-lineutils-line="1" class="cke_reset_all" style="{lineStyle}"><span style="{tipLeftStyle}">&nbsp;</span><span style="{tipRightStyle}">&nbsp;</span></div>';t.prototype={removeAll:function(){var e;for(e in this.hidden)this.hidden[e].remove(),delete this.hidden[e];for(e in this.visible)this.visible[e].remove(),delete this.visible[e]},hideLine:function(e){var a=e.getUniqueId();e.hide(),this.hidden[a]=e,delete this.visible[a]},showLine:function(e){var a=e.getUniqueId();e.show(),this.visible[a]=e,delete this.hidden[a]},hideVisible:function(){for(var e in this.visible)this.hideLine(this.visible[e])},placeLine:function(e,a){var t,i,o;if(t=this.getStyle(e.uid,e.type)){for(o in this.visible)if(this.visible[o].getCustomData("hash")!==this.hash){i=this.visible[o];break}if(!i)for(o in this.hidden)if(this.hidden[o].getCustomData("hash")!==this.hash){this.showLine(i=this.hidden[o]);break}i||this.showLine(i=this.addLine()),i.setCustomData("hash",this.hash),this.visible[i.getUniqueId()]=i,i.setStyles(t),a&&a(i)}},getStyle:function(e,a){var t,i=this.relations[e],o=this.locations[e][a],n={};if(i.siblingRect?n.width=Math.max(i.siblingRect.width,i.elementRect.width):n.width=i.elementRect.width,this.inline?n.top=o+this.winTopScroll.y-this.rect.relativeY:n.top=this.rect.top+this.winTopScroll.y+o,n.top-this.winTopScroll.y<this.rect.top||n.top-this.winTopScroll.y>this.rect.bottom)return!1;this.inline?n.left=i.elementRect.left-this.rect.relativeX:(i.elementRect.left>0?n.left=this.rect.left+i.elementRect.left:(n.width+=i.elementRect.left,n.left=this.rect.left),(t=n.left+n.width-(this.rect.left+this.winPane.width))>0&&(n.width-=t)),n.left+=this.winTopScroll.x;for(var l in n)n[l]=CKEDITOR.tools.cssLength(n[l]);return n},addLine:function(){var e=CKEDITOR.dom.element.createFromHtml(this.lineTpl);return e.appendTo(this.container),e},prepare:function(e,a){this.relations=e,this.locations=a,this.hash=Math.random()},cleanup:function(){var e;for(var a in this.visible)e=this.visible[a],e.getCustomData("hash")!==this.hash&&this.hideLine(e)},queryViewport:function(){this.winPane=this.win.getViewPaneSize(),this.winTopScroll=this.winTop.getScrollPosition(),this.winTopPane=this.winTop.getViewPaneSize(),this.rect=this.getClientRect(this.inline?this.editable:this.frame)},getClientRect:function(e){var a=e.getClientRect(),t=this.container.getDocumentPosition(),i=this.container.getComputedStyle("position");return a.relativeX=a.relativeY=0,"static"!=i&&(a.relativeY=t.y,a.relativeX=t.x,a.top-=a.relativeY,a.bottom-=a.relativeY,a.left-=a.relativeX,a.right-=a.relativeX),a}};var p={left:1,right:1,center:1},m={absolute:1,fixed:1};CKEDITOR.plugins.lineutils={finder:e,locator:a,liner:t}}();